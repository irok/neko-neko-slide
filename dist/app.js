"use strict";!function(){function e(){for(var e=[],n=0,t=0;t<G.game.board.count-1;t++)e[t]=G.game.board.panels[t].picId;for(t=0;t<G.game.board.count-1;t++)-1!==e[t]&&(n+=a(e,t)-1);return n>=G.game.board.count-G.game.size&&n%2==0}function a(e,a){for(var n,t=1,o=e[a];e[a]>=0&&o!==a;)t++,n=o,o=e[o],e[n]=-1;return t}function n(){G.initGame(0),l(P);var e=[12,0,2,14,12,8,11,3,2,14],a=G.game.board.slidePanel.bind(G.game.board);e.concat(15).forEach(a);var n=function(t){if(0===e.length)return t();a(e.pop()),setTimeout(n.bind(null,t),100)};P.attr("data-state",""),D["start.png"].removeClass("playing"),L.changePage("title",function(){e.unshift(15),setTimeout(function(){n(function(){h(P,function(){D["start.png"].addClass("playing")})})},1500)})}function t(){G.loadUserData(function(){$(".stage-panel").each(function(e){var a=$(this),n=G.getLastStage(),t=e+1;e<=n?(a.addClass("selectable"),e<n?a.css("backgroundImage",'url("image/cat-'+t+'.jpg")'):a.css("backgroundImage",'url("image/stage-next.png")')):(a.removeClass("selectable"),a.css("backgroundImage",'url("image/stage-unknown.png")'))}),L.changePage("select")})}function o(e){G.initGame(e),l(w),c(),u(),w.attr("data-state",""),D["gameover.png"].removeClass("playing").hide(),L.changePage("game",function(){L.shield.on(),L.serial([[1200,f],[2e3,m],[800,p],[500,function(){L.shield.off(),s()}]])})}function s(){G.game.timerId=setInterval(function(){0==--G.game.score.time&&g(),u()},1e3)}function i(){clearInterval(G.game.timerId),L.shield.on()}function r(){i();var e=G.game.score.time*S-G.game.score.move*T;e<0&&(e=0);var a=G.getLastStage();a<G.game.stage&&(a=G.game.stage),G.saveUserData(a,e,function(){h(w,function(){v(function(){b(function(){I.shield.one(j,t)})})})})}function g(){i(),y(w,function(){I.shield.one(j,t)})}function l(e){e.empty(),G.game.board.panels=[];for(var a=0;a<G.game.board.count;a++){var n=L.idx2pos(a);G.game.board.panels.push({picId:a,$elem:$("<div/>").addClass("panel").addClass("panel-size"+G.game.size).css("background-image",'url("image/cat-'+G.game.stage+'.jpg")').css("background-position",L.px(-n.x)+" "+L.px(-n.y)).css("left",n.x).css("top",n.y).data("picId",a).appendTo(e)})}}function c(){G.game.board.shuffle()}function d(){for(var e=$(this).data("picId"),a=-1,n=0;n<G.game.board.count;n++)if(G.game.board.panels[n].picId===e){a=n;break}var t=G.game.board.slidePanel(a);t>0&&(G.game.score.move++,u(),2===t&&r())}function u(){z.stage.text(G.game.stage),z.score.text(G.game.score.score),z.time.text(G.game.score.time),z.move.text(G.game.score.move)}function m(e){for(var a=0;a<G.game.board.count;a++)G.game.board.movePanel(a);e()}function f(e){e(),L.log("ready:show"),D["ready.png"].show(),L.serial([[10,function(e){L.log("ready:playing"),D["ready.png"].addClass("playing"),e()}],[2e3,function(){L.log("ready:finish"),D["ready.png"].removeClass("playing").hide()}]])}function p(e){e(),L.log("go:show"),D["go.png"].show(),L.serial([[10,function(e){L.log("go:playing"),D["go.png"].addClass("playing"),e()}],[1e3,function(){L.log("go:finish"),D["go.png"].removeClass("playing").hide()}]])}function h(e,a){L.serial([[10,function(a){e.attr("data-state","flush"),a()}],[500,function(a){e.attr("data-state","clear"),a()}],[500,a]])}function v(e){var a=["c","l","e","a","r"];L.serial(a.map(function(e){return[100,function(a){D["clear-"+e+".png"].addClass("playing"),a()}]}).concat([[1500,function(e){a.forEach(function(e){D["clear-"+e+".png"].addClass("end")}),e()}],[1e3,function(){a.forEach(function(e){D["clear-"+e+".png"].removeClass("playing").removeClass("end")}),e()}]]))}function b(e){var a=G.game.score,n=function(e){if(0===a.time)return e();a.time>=3?(a.time-=3,a.score+=3*S):(a.score+=S*a.time,a.time=0),u(),setTimeout(n.bind(null,e),30)},t=function(e){if(0===a.move)return e();a.move--,a.score-=T,a.score<0&&(a.score=0),u(),setTimeout(t.bind(null,e),30)};L.serial([[300,n],[900,t],[10,e]])}function y(e,a){L.serial([[1e3,function(a){L.log("grayscale"),e.attr("data-state","gameover"),a()}],[1200,function(e){L.log("gameover:ready"),D["gameover.png"].show(),e()}],[100,function(){L.log("gameover:playing"),D["gameover.png"].addClass("playing"),a()}]])}function C(){if(!E.loaded())return L.log("Wait to load images..."),void setTimeout(C,100);L.log("All images were loaded."),x=$("#container").append(D["ready.png"].addClass("anim-ready").hide()).append(D["go.png"].addClass("anim-go").hide()),I={title:$("#page-title").append(D["start.png"].addClass("anim-start")),select:$("#page-select"),game:$("#page-game").append(D["gameover.png"].addClass("anim-gameover")),shield:$("#page-shield")},P=$("#title-board"),w=$("#game-board").on(j,".panel",d),z={stage:$("#game-stage"),score:$("#high-score"),time:$("#rest-time"),move:$("#move-count")},["c","l","e","a","r"].forEach(function(e,a){D["clear-"+e+".png"].addClass("anim-clear").css("left",18+115*a).appendTo(I.game)}),I.title.on(j,t);for(var e=1;e<=16;e++)$("<div/>").addClass("stage-panel").attr("data-stage",e).appendTo(I.select);I.select.on(j,".stage-panel.selectable",function(){o($(this).data("stage"))}),n(),G.getCurrentPage().fadeIn(500)}for(var x,I,P,w,z,k=[4,3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,6],S=270,T=90,D={},E=["start.png","stage-next.png","stage-unknown.png","ready.png","go.png","clear-c.png","clear-l.png","clear-e.png","clear-a.png","clear-r.png","gameover.png"],U=0;U<=16;U++)E.push("cat-"+U+".jpg");E.loadCount=0,E.loaded=function(){return this.loadCount===this.length};var j="mousedown touchstart",G=function(){var a="title",n={lastStage:0};return{game:{board:{panels:[],shuffle:function(){do{for(var a=this.count-1;--a>=0;){var n=Math.floor(Math.random()*(a+1));this.swapPanel(a,n)}}while(!e())},swapPanel:function(e,a){var n=this.panels[e];this.panels[e]=this.panels[a],this.panels[a]=n},movePanel:function(e){var a=L.idx2pos(e);this.panels[e].$elem.css("left",a.x).css("top",a.y)},sorted:function(){for(var e=0;e<this.count;e++)if(this.panels[e].picId!==e)return!1;return!0},slidePanel:function(e){var a=L.idx2pos(e),n=L.idx2pos(this.blankIndex);if(a.x!==n.x&&a.y!==n.y)return 0;var t;t=a.y===n.y?n.x<a.x?1:-1:(n.y<a.y?1:-1)*G.game.size;for(var o=this.blankIndex;o!=e;o+=t)this.swapPanel(o,o+t),this.movePanel(o);return this.movePanel(this.blankIndex=e),this.sorted()?2:1}}},getCurrentPage:function(){return $("#page-"+a)},setCurrentPage:function(e){return a=e,this.getCurrentPage()},getLastStage:function(){return n.lastStage},loadUserData:function(e){var a=localStorage.getItem("userData");a&&(n=JSON.parse(a)),e()},saveUserData:function(e,a,t){n.lastStage=e,n.highScore=a,localStorage.setItem("userData",JSON.stringify(n)),t()},initGame:function(e){this.game.stage=e,this.game.size=k[e],this.game.board.count=this.game.size*this.game.size,this.game.board.blankIndex=this.game.board.count-1,this.game.board.size=420/this.game.size,this.game.board.panels=[],this.game.score={score:0,time:30*this.game.board.count+10*e,move:0},this.game.timerId=null}}}(),L={idx2pos:function(e){return{x:parseInt(e%G.game.size)*G.game.board.size,y:parseInt(e/G.game.size)*G.game.board.size}},px:function(e){return 0===e?0:e+"px"},shield:{on:function(){I.shield.show()},off:function(){I.shield.hide()}},serial:function(e){var a=-1,n=function(){++a<e.length&&setTimeout(function(){e[a][1](n)},e[a][0])};n()},changePage:function(e,a){L.shield.on(),G.getCurrentPage().fadeOut(200,function(){G.setCurrentPage(e).fadeIn(200,function(){L.shield.off(),a&&a()})})},log:function(){console.info.apply(console,arguments)}};E.forEach(function(e){D[e]=$('<img src="image/'+e+'"/>').on("load",function(){E.loadCount++}).on("error",function(){E.loadCount++,console.warn("Can't load "+e)})}),$(C)}();