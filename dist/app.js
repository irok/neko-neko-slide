"use strict";"undefined"==typeof game_start&&(window.game_start=window.game_end=window.show_ad=function(e){e.callback()},window.game_save=function(e){localStorage.setItem("userData",JSON.stringify(e.data)),e.callback()},window.game_get_data=function(e){var a=localStorage.getItem("userData");e.callback(a?JSON.parse(a):{})}),function(){for(var n,o,t,i,a=[4,3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,6],s=270,r=90,g={},c=["start.png","stage-next.png","stage-unknown.png","ready.png","go.png","clear-c.png","clear-l.png","clear-e.png","clear-a.png","clear-r.png","gameover.png"],e=0;e<=16;e++)c.push("cat-"+e+".jpg");c.loadCount=0,c.loaded=function(){return this.loadCount===this.length};var l,d,u="mousedown touchstart",m=(l="title",d={},{game:{board:{panels:[],shuffle:function(){do{for(var e=this.count-1;0<=--e;){var a=Math.floor(Math.random()*(e+1));this.swapPanel(e,a)}}while(!p())},swapPanel:function(e,a){var n=this.panels[e];this.panels[e]=this.panels[a],this.panels[a]=n},movePanel:function(e){var a=f.idx2pos(e);this.panels[e].$elem.css("left",a.x).css("top",a.y)},sorted:function(){for(var e=0;e<this.count;e++)if(this.panels[e].picId!==e)return!1;return!0},slidePanel:function(e){var a,n=f.idx2pos(e),t=f.idx2pos(this.blankIndex);if(n.x!==t.x&&n.y!==t.y)return 0;a=n.y===t.y?t.x<n.x?1:-1:(t.y<n.y?1:-1)*m.game.size;for(var o=this.blankIndex;o!=e;o+=a)this.swapPanel(o,o+a),this.movePanel(o);return this.movePanel(this.blankIndex=e),this.sorted()?2:1}}},getCurrentPageId:function(){return l},getCurrentPage:function(){return $("#page-"+l)},setCurrentPage:function(e){return l=e,this.getCurrentPage()},getLastStage:function(){return d.lastStage||0},loadUserData:function(a){window.game_get_data({callback:function(e){d=e,a()}})},saveUserData:function(e,a,n){d.lastStage=e,d.highScore=a,window.game_save({callback:n,data:d})},initGame:function(e){this.game.stage=e,this.game.size=a[e],this.game.board.count=this.game.size*this.game.size,this.game.board.blankIndex=this.game.board.count-1,this.game.board.size=420/this.game.size,this.game.board.panels=[],this.game.score={score:0,time:30*this.game.board.count+10*e,move:0},this.game.timerId=null}}),f={idx2pos:function(e){return{x:parseInt(e%m.game.size)*m.game.board.size,y:parseInt(e/m.game.size)*m.game.board.size}},px:function(e){return 0===e?0:e+"px"},shield:{on:function(){n.shield.show()},off:function(){n.shield.hide()}},serial:function(e){var a=-1,n=function(){++a<e.length&&setTimeout(function(){e[a][1](n)},e[a][0])};n()},changePage:function(e,a){f.shield.on(),m.getCurrentPage().fadeOut(200,function(){m.setCurrentPage(e).fadeIn(200,function(){f.shield.off(),a&&a()})})},log:function(){console.info.apply(console,arguments)}};function p(){for(var e=[],a=0,n=0;n<m.game.board.count-1;n++)e[n]=m.game.board.panels[n].picId;for(n=0;n<m.game.board.count-1;n++)-1!==e[n]&&(a+=h(e,n)-1);return a>=m.game.board.count-m.game.size&&a%2==0}function h(e,a){for(var n,t=1,o=e[a];0<=e[a]&&o!==a;)t++,o=e[n=o],e[n]=-1;return t}function v(){m.loadUserData(function(){$(".stage-panel").each(function(e){var a=$(this),n=m.getLastStage(),t=e+1;e<=n?(a.addClass("selectable"),e<n?a.css("backgroundImage",'url("image/cat-'+t+'.jpg")'):a.css("backgroundImage",'url("image/stage-next.png")')):(a.removeClass("selectable"),a.css("backgroundImage",'url("image/stage-unknown.png")'))}),f.changePage("select")})}function b(e){m.initGame(e),x(t),m.game.board.shuffle(),P(),t.attr("data-state",""),g["gameover.png"].removeClass("playing").hide(),f.changePage("game",function(){f.shield.on(),f.serial([[1200,z],[2e3,k],[800,_],[500,function(){f.shield.off(),window.game_start({callback:y})}]])})}function y(){m.game.timerId=setInterval(function(){0==--m.game.score.time&&C(0,function(){!function(a,e){f.serial([[1e3,function(e){f.log("grayscale"),a.attr("data-state","gameover"),e()}],[1200,function(e){f.log("gameover:ready"),g["gameover.png"].show(),e()}],[100,function(){f.log("gameover:playing"),g["gameover.png"].addClass("playing"),e()}]])}(t,function(){n.shield.one(u,v)})}),P()},1e3)}function C(e,a){clearInterval(m.game.timerId),f.shield.on(),window.game_end({callback:a,score:e})}function w(){var e=m.game.score.time*s-m.game.score.move*r;e<0&&(e=0);var a=m.getLastStage();a<m.game.stage&&(a=m.game.stage),C(e,function(){m.saveUserData(a,e,function(){S(t,function(){!function(e){var a=["c","l","e","a","r"];f.serial(a.map(function(a){return[100,function(e){g["clear-"+a+".png"].addClass("playing"),e()}]}).concat([[1500,function(e){a.forEach(function(e){g["clear-"+e+".png"].addClass("end")}),e()}],[1e3,function(){a.forEach(function(e){g["clear-"+e+".png"].removeClass("playing").removeClass("end")}),e()}]]))}(function(){!function(e){var a=m.game.score,n=function(e){if(0===a.time)return e();3<=a.time?(a.time-=3,a.score+=3*s):(a.score+=s*a.time,a.time=0),P(),setTimeout(n.bind(null,e),30)},t=function(e){if(0===a.move)return e();a.move--,a.score-=r,a.score<0&&(a.score=0),P(),setTimeout(t.bind(null,e),30)};f.serial([[300,n],[900,t],[10,e]])}(function(){n.shield.one(u,v)})})})})})}function x(e){e.empty(),m.game.board.panels=[];for(var a=0;a<m.game.board.count;a++){var n=f.idx2pos(a);m.game.board.panels.push({picId:a,$elem:$("<div/>").addClass("panel").addClass("panel-size"+m.game.size).css("background-image",'url("image/cat-'+m.game.stage+'.jpg")').css("background-position",f.px(-n.x)+" "+f.px(-n.y)).css("left",n.x).css("top",n.y).data("picId",a).appendTo(e)})}}function I(){for(var e=$(this).data("picId"),a=-1,n=0;n<m.game.board.count;n++)if(m.game.board.panels[n].picId===e){a=n;break}var t=m.game.board.slidePanel(a);0<t&&(m.game.score.move++,P(),2===t&&w())}function P(){i.stage.text(m.game.stage),i.score.text(m.game.score.score),i.time.text(m.game.score.time),i.move.text(m.game.score.move)}function k(e){for(var a=0;a<m.game.board.count;a++)m.game.board.movePanel(a);e()}function z(e){e(),f.log("ready:show"),g["ready.png"].show(),f.serial([[10,function(e){f.log("ready:playing"),g["ready.png"].addClass("playing"),e()}],[2e3,function(){f.log("ready:finish"),g["ready.png"].removeClass("playing").hide()}]])}function _(e){e(),f.log("go:show"),g["go.png"].show(),f.serial([[10,function(e){f.log("go:playing"),g["go.png"].addClass("playing"),e()}],[1e3,function(){f.log("go:finish"),g["go.png"].removeClass("playing").hide()}]])}function S(a,e){f.serial([[10,function(e){a.attr("data-state","flush"),e()}],[500,function(e){a.attr("data-state","clear"),e()}],[500,e]])}c.forEach(function(e){g[e]=$('<img src="image/'+e+'"/>').on("load",function(){c.loadCount++}).on("error",function(){c.loadCount++,console.warn("Can't load "+e)})}),$(function e(){if(!c.loaded())return f.log("Wait to load images..."),void setTimeout(e,100);f.log("All images were loaded."),$("#container").append(g["ready.png"].addClass("anim-ready").hide()).append(g["go.png"].addClass("anim-go").hide()),n={title:$("#page-title").append(g["start.png"].addClass("anim-start")),select:$("#page-select"),game:$("#page-game").append(g["gameover.png"].addClass("anim-gameover")),shield:$("#page-shield")},o=$("#title-board"),t=$("#game-board").on(u,".panel",I),i={stage:$("#game-stage"),score:$("#high-score"),time:$("#rest-time"),move:$("#move-count")},["c","l","e","a","r"].forEach(function(e,a){g["clear-"+e+".png"].addClass("anim-clear").css("left",18+115*a).appendTo(n.game)}),n.title.on(u,v);for(var a=1;a<=16;a++)$("<div/>").addClass("stage-panel").attr("data-stage",a).appendTo(n.select);n.select.on(u,".stage-panel.selectable",function(){b($(this).data("stage"))}),function(){m.initGame(0),x(o);var a=[12,0,2,14,12,8,11,3,2,14],n=m.game.board.slidePanel.bind(m.game.board);a.concat(15).forEach(n);var t=function(e){if("title"===m.getCurrentPageId()){if(0===a.length)return e();n(a.pop()),setTimeout(t.bind(null,e),100)}};o.attr("data-state",""),g["start.png"].removeClass("playing"),f.changePage("title",function(){a.unshift(15),setTimeout(function(){t(function(){S(o,function(){g["start.png"].addClass("playing")})})},1500)})}(),m.getCurrentPage().fadeIn(500)})}();