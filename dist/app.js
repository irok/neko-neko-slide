"use strict";"undefined"==typeof game_start&&(window.game_start=window.game_end=window.show_ad=function(e){e.callback()},window.game_save=function(e){localStorage.setItem("userData",JSON.stringify(e.data)),e.callback()},window.game_get_data=function(e){var a=localStorage.getItem("userData");e.callback(a?JSON.parse(a):{})}),function(){function e(){for(var e=[],n=0,t=0;t<j.game.board.count-1;t++)e[t]=j.game.board.panels[t].picId;for(t=0;t<j.game.board.count-1;t++)-1!==e[t]&&(n+=a(e,t)-1);return n>=j.game.board.count-j.game.size&&n%2==0}function a(e,a){for(var n,t=1,o=e[a];e[a]>=0&&o!==a;)t++,n=o,o=e[o],e[n]=-1;return t}function n(){j.initGame(0),c(I);var e=[12,0,2,14,12,8,11,3,2,14],a=j.game.board.slidePanel.bind(j.game.board);e.concat(15).forEach(a);var n=function(t){if("title"===j.getCurrentPageId()){if(0===e.length)return t();a(e.pop()),setTimeout(n.bind(null,t),100)}};I.attr("data-state",""),T["start.png"].removeClass("playing"),G.changePage("title",function(){e.unshift(15),setTimeout(function(){n(function(){h(I,function(){T["start.png"].addClass("playing")})})},1500)})}function t(){j.loadUserData(function(){$(".stage-panel").each(function(e){var a=$(this),n=j.getLastStage(),t=e+1;e<=n?(a.addClass("selectable"),e<n?a.css("backgroundImage",'url("image/cat-'+t+'.jpg")'):a.css("backgroundImage",'url("image/stage-next.png")')):(a.removeClass("selectable"),a.css("backgroundImage",'url("image/stage-unknown.png")'))}),G.changePage("select")})}function o(e){j.initGame(e),c(P),l(),u(),P.attr("data-state",""),T["gameover.png"].removeClass("playing").hide(),G.changePage("game",function(){G.shield.on(),G.serial([[1200,f],[2e3,m],[800,p],[500,function(){G.shield.off(),window.game_start({callback:i})}]])})}function i(){j.game.timerId=setInterval(function(){0==--j.game.score.time&&g(),u()},1e3)}function s(e,a){clearInterval(j.game.timerId),G.shield.on(),window.game_end({callback:a,score:e})}function r(){var e=j.game.score.time*_-j.game.score.move*S;e<0&&(e=0);var a=j.getLastStage();a<j.game.stage&&(a=j.game.stage),s(e,function(){j.saveUserData(a,e,function(){h(P,function(){v(function(){b(function(){x.shield.one(U,t)})})})})})}function g(){s(0,function(){y(P,function(){x.shield.one(U,t)})})}function c(e){e.empty(),j.game.board.panels=[];for(var a=0;a<j.game.board.count;a++){var n=G.idx2pos(a);j.game.board.panels.push({picId:a,$elem:$("<div/>").addClass("panel").addClass("panel-size"+j.game.size).css("background-image",'url("image/cat-'+j.game.stage+'.jpg")').css("background-position",G.px(-n.x)+" "+G.px(-n.y)).css("left",n.x).css("top",n.y).data("picId",a).appendTo(e)})}}function l(){j.game.board.shuffle()}function d(){for(var e=$(this).data("picId"),a=-1,n=0;n<j.game.board.count;n++)if(j.game.board.panels[n].picId===e){a=n;break}var t=j.game.board.slidePanel(a);t>0&&(j.game.score.move++,u(),2===t&&r())}function u(){k.stage.text(j.game.stage),k.score.text(j.game.score.score),k.time.text(j.game.score.time),k.move.text(j.game.score.move)}function m(e){for(var a=0;a<j.game.board.count;a++)j.game.board.movePanel(a);e()}function f(e){e(),G.log("ready:show"),T["ready.png"].show(),G.serial([[10,function(e){G.log("ready:playing"),T["ready.png"].addClass("playing"),e()}],[2e3,function(){G.log("ready:finish"),T["ready.png"].removeClass("playing").hide()}]])}function p(e){e(),G.log("go:show"),T["go.png"].show(),G.serial([[10,function(e){G.log("go:playing"),T["go.png"].addClass("playing"),e()}],[1e3,function(){G.log("go:finish"),T["go.png"].removeClass("playing").hide()}]])}function h(e,a){G.serial([[10,function(a){e.attr("data-state","flush"),a()}],[500,function(a){e.attr("data-state","clear"),a()}],[500,a]])}function v(e){var a=["c","l","e","a","r"];G.serial(a.map(function(e){return[100,function(a){T["clear-"+e+".png"].addClass("playing"),a()}]}).concat([[1500,function(e){a.forEach(function(e){T["clear-"+e+".png"].addClass("end")}),e()}],[1e3,function(){a.forEach(function(e){T["clear-"+e+".png"].removeClass("playing").removeClass("end")}),e()}]]))}function b(e){var a=j.game.score,n=function(e){if(0===a.time)return e();a.time>=3?(a.time-=3,a.score+=3*_):(a.score+=_*a.time,a.time=0),u(),setTimeout(n.bind(null,e),30)},t=function(e){if(0===a.move)return e();a.move--,a.score-=S,a.score<0&&(a.score=0),u(),setTimeout(t.bind(null,e),30)};G.serial([[300,n],[900,t],[10,e]])}function y(e,a){G.serial([[1e3,function(a){G.log("grayscale"),e.attr("data-state","gameover"),a()}],[1200,function(e){G.log("gameover:ready"),T["gameover.png"].show(),e()}],[100,function(){G.log("gameover:playing"),T["gameover.png"].addClass("playing"),a()}]])}function C(){if(!D.loaded())return G.log("Wait to load images..."),void setTimeout(C,100);G.log("All images were loaded."),w=$("#container").append(T["ready.png"].addClass("anim-ready").hide()).append(T["go.png"].addClass("anim-go").hide()),x={title:$("#page-title").append(T["start.png"].addClass("anim-start")),select:$("#page-select"),game:$("#page-game").append(T["gameover.png"].addClass("anim-gameover")),shield:$("#page-shield")},I=$("#title-board"),P=$("#game-board").on(U,".panel",d),k={stage:$("#game-stage"),score:$("#high-score"),time:$("#rest-time"),move:$("#move-count")},["c","l","e","a","r"].forEach(function(e,a){T["clear-"+e+".png"].addClass("anim-clear").css("left",18+115*a).appendTo(x.game)}),x.title.on(U,t);for(var e=1;e<=16;e++)$("<div/>").addClass("stage-panel").attr("data-stage",e).appendTo(x.select);x.select.on(U,".stage-panel.selectable",function(){o($(this).data("stage"))}),n(),j.getCurrentPage().fadeIn(500)}for(var w,x,I,P,k,z=[4,3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,6],_=270,S=90,T={},D=["start.png","stage-next.png","stage-unknown.png","ready.png","go.png","clear-c.png","clear-l.png","clear-e.png","clear-a.png","clear-r.png","gameover.png"],E=0;E<=16;E++)D.push("cat-"+E+".jpg");D.loadCount=0,D.loaded=function(){return this.loadCount===this.length};var U="mousedown touchstart",j=function(){var a="title",n={};return{game:{board:{panels:[],shuffle:function(){do{for(var a=this.count-1;--a>=0;){var n=Math.floor(Math.random()*(a+1));this.swapPanel(a,n)}}while(!e())},swapPanel:function(e,a){var n=this.panels[e];this.panels[e]=this.panels[a],this.panels[a]=n},movePanel:function(e){var a=G.idx2pos(e);this.panels[e].$elem.css("left",a.x).css("top",a.y)},sorted:function(){for(var e=0;e<this.count;e++)if(this.panels[e].picId!==e)return!1;return!0},slidePanel:function(e){var a=G.idx2pos(e),n=G.idx2pos(this.blankIndex);if(a.x!==n.x&&a.y!==n.y)return 0;var t;t=a.y===n.y?n.x<a.x?1:-1:(n.y<a.y?1:-1)*j.game.size;for(var o=this.blankIndex;o!=e;o+=t)this.swapPanel(o,o+t),this.movePanel(o);return this.movePanel(this.blankIndex=e),this.sorted()?2:1}}},getCurrentPageId:function(){return a},getCurrentPage:function(){return $("#page-"+a)},setCurrentPage:function(e){return a=e,this.getCurrentPage()},getLastStage:function(){return n.lastStage||0},loadUserData:function(e){window.game_get_data({callback:function(a){n=a,e()}})},saveUserData:function(e,a,t){n.lastStage=e,n.highScore=a,window.game_save({callback:t,data:n})},initGame:function(e){this.game.stage=e,this.game.size=z[e],this.game.board.count=this.game.size*this.game.size,this.game.board.blankIndex=this.game.board.count-1,this.game.board.size=420/this.game.size,this.game.board.panels=[],this.game.score={score:0,time:30*this.game.board.count+10*e,move:0},this.game.timerId=null}}}(),G={idx2pos:function(e){return{x:parseInt(e%j.game.size)*j.game.board.size,y:parseInt(e/j.game.size)*j.game.board.size}},px:function(e){return 0===e?0:e+"px"},shield:{on:function(){x.shield.show()},off:function(){x.shield.hide()}},serial:function(e){var a=-1,n=function(){++a<e.length&&setTimeout(function(){e[a][1](n)},e[a][0])};n()},changePage:function(e,a){G.shield.on(),j.getCurrentPage().fadeOut(200,function(){j.setCurrentPage(e).fadeIn(200,function(){G.shield.off(),a&&a()})})},log:function(){console.info.apply(console,arguments)}};D.forEach(function(e){T[e]=$('<img src="image/'+e+'"/>').on("load",function(){D.loadCount++}).on("error",function(){D.loadCount++,console.warn("Can't load "+e)})}),$(C)}();